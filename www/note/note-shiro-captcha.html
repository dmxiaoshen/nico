<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>shiro实现验证码认证</title>
	<link rel="shortcut icon" href="../static/img/favicon.ico">
    <link rel="stylesheet" type="text/css" media="all" href="../static/css/style.css" />
	<link rel="stylesheet" type="text/css" media="all" href="../static/css/highlight.css" />
    <link rel="stylesheet" type="text/css" media="all" href="../static/css/prettify.css" />
</head>
<body>
    <div id="primary">
        <header id="header">
    <h1 id="site-title">
        <a href="/" title="dmxiaoshen's Blog" rel="home">
            dmxiaoshen's Blog
        </a>
    </h1>
    <nav id="nav">
        <ul>
            <li>
                <a href="/note/">
                    晴耕
                </a>
            </li>
            <li>
                <a href="/article/">
                    雨读
                </a>
            </li>
        </ul>
    </nav>
</header>
        <section id="content">
<h2 class="post_title">shiro实现验证码认证</h2>
<article>
    <h2 id="前言">前言</h2><p>上篇最后的遗留问题就是验证码的问题，其实shiro本身是支持验证码扩展的。这里我们可以有两种方法。<br>我们前台页面是表单的提交，针对这个我们有两种思路。一是在表单提交之前去检验验证码，通过之后才能提交，<br>二是表单先提交上去，与用户名密码一同处理，只是顺序靠前。  </p>
<h2 id="第一种方法">第一种方法</h2><p>这种方法，就是普通的表单元素验证。这里用到ajax（类似用户名的重复性验证）。同时用到js的一个验证框架query.validationEngine.js.<br>具体也不多说，直接看代码:<br><!--more--></p>
<div class="highlight"><pre><code class="javascript">&lt;script type=<span class="string">"text/javascript"</span>&gt;
<span class="keyword">var</span> ctx = <span class="string">"${ctx}"</span>;
$(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>    

    $(<span class="string">"#capt"</span>).click(<span class="function"><span class="keyword">function</span><span class="params">()</span>{</span>
        $(<span class="string">"#imgs"</span>).attr(<span class="string">"src"</span>,<span class="string">"${ctx}/login/getCaptcha?time="</span>+(<span class="keyword">new</span> Date()).getTime());
    });

    $(<span class="string">"#form"</span>).validationEngine({
        validationEventTrigger:<span class="string">""</span>,
        promptPosition : <span class="string">"centerRight"</span>,
        scroll : <span class="literal">false</span>,
        maxErrorsPerField : <span class="number">1</span>,
        customFunctions:{
            checkCaptcha:checkCaptcha
        },
        onValidationComplete : <span class="function"><span class="keyword">function</span><span class="params">(form,valid)</span>{</span>
            <span class="keyword">if</span>(valid){
                <span class="keyword">return</span> <span class="literal">true</span>;
            }
        }
    });    

    <span class="function"><span class="keyword">function</span> <span class="title">checkCaptcha</span><span class="params">($field, rules, i, options)</span>{</span>
         <span class="keyword">var</span> parmCode = $field.val();

            <span class="keyword">var</span> isOk = <span class="literal">false</span>;
            $.ajax({
                type:<span class="string">"post"</span>,
                async:<span class="literal">false</span>,
                url:ctx+<span class="string">"/login/checkCaptcha"</span>,
                data:{
                    captcha:parmCode
                },
                dataType:<span class="string">"json"</span>,
                success:<span class="function"><span class="keyword">function</span><span class="params">(data)</span>{</span>                
                        isOk = data;                
                }

            });

            <span class="keyword">if</span>(isOk){                
                <span class="keyword">return</span> <span class="string">"* 验证码错误"</span>;
            }
    }
});
<span class="xml"><span class="tag">&lt;/<span class="title">script</span>&gt;</span>

<span class="tag">&lt;<span class="title">p</span>&gt;</span>
<span class="tag">&lt;<span class="title">label</span>&gt;</span>验证码:<span class="tag">&lt;/<span class="title">label</span>&gt;</span>
<span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"text"</span> <span class="attribute">maxlength</span>=<span class="value">4</span> <span class="attribute">name</span>=<span class="value">"captcha"</span> <span class="attribute">class</span>=<span class="value">"validate[required,funcCall[checkCaptcha]]"</span>/&gt;</span>
<span class="tag">&lt;<span class="title">img</span> <span class="attribute">src</span>=<span class="value">"getCaptcha"</span> <span class="attribute">id</span>=<span class="value">"imgs"</span> /&gt;</span>&amp;nbsp;<span class="tag">&lt;<span class="title">a</span> <span class="attribute">id</span>=<span class="value">"capt"</span> <span class="attribute">href</span>=<span class="value">"#"</span>&gt;</span>看不清<span class="tag">&lt;/<span class="title">a</span>&gt;</span>
<span class="tag">&lt;/<span class="title">p</span>&gt;</span></span></code></pre></div><p>后台服务:  </p>
<div class="highlight"><pre><code class="java"> <span class="annotation">@RequestMapping</span>(value = <span class="string">"/getCaptcha"</span>)
    <span class="keyword">public</span> <span class="keyword">void</span> getCaptcha(OutputStream out, HttpSession session) {
        String code = RandomStringUtils.random(<span class="number">4</span>,<span class="keyword">true</span>,<span class="keyword">true</span>);
        <span class="keyword">try</span> {
            CaptchaUtil.writeImage(code, out);
            session.setAttribute(AppConstants.CAPTCHA_CODE, code);
        } <span class="keyword">catch</span> (IOException e) {
            <span class="comment">// 网络异常</span>
            session.removeAttribute(AppConstants.CAPTCHA_CODE);
        }
    }

 <span class="annotation">@RequestMapping</span>(value=<span class="string">"/checkCaptcha"</span>)
 <span class="annotation">@ResponseBody</span>
  <span class="keyword">public</span> <span class="keyword">boolean</span> checkCaptcha(String captcha,HttpSession session){
    String cap = (String)session.getAttribute(AppConstants.CAPTCHA_CODE);
    <span class="keyword">return</span> !cap.equalsIgnoreCase(captcha);
}</code></pre></div><p>这种方法完全不用修改原先的shiro各种配置。  </p>
<h2 id="第二种方法">第二种方法</h2><p>需要一个CaptchaUsernamePasswordToken类继承UsernamePasswordToken来扩展验证码  </p>
<div class="highlight"><pre><code class="java"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CaptchaUsernamePasswordToken</span> <span class="keyword">extends</span> <span class="title">UsernamePasswordToken</span> </span>{

    <span class="javadoc">/** */</span>
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2793965333840597519</span>L;

    <span class="keyword">private</span> String captcha;

    <span class="keyword">public</span> CaptchaUsernamePasswordToken(String username, <span class="keyword">char</span>[] password, <span class="keyword">boolean</span> rememberMe, String host,
            String captcha) {
        <span class="keyword">super</span>(username, password, rememberMe, host);
        this.captcha = captcha;
    }

    <span class="keyword">public</span> String getCaptcha() {
        <span class="keyword">return</span> captcha;
    }

    <span class="keyword">public</span> <span class="keyword">void</span> setCaptcha(String captcha) {
        this.captcha = captcha;
    }

}</code></pre></div><p>需要有一个异常IncorrectCaptchaException，方便定位到验证码错误  </p>
<div class="highlight"><pre><code class="java"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IncorrectCaptchaException</span> <span class="keyword">extends</span> <span class="title">AuthenticationException</span> </span>{

    <span class="javadoc">/** */</span>
    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">4918785444665781681</span>L;

    <span class="keyword">public</span> IncorrectCaptchaException() {
        <span class="keyword">super</span>();
    }

    <span class="keyword">public</span> IncorrectCaptchaException(String message, Throwable cause) {
        <span class="keyword">super</span>(message, cause);
    }

    <span class="keyword">public</span> IncorrectCaptchaException(String message) {
        <span class="keyword">super</span>(message);
    }

    <span class="keyword">public</span> IncorrectCaptchaException(Throwable cause) {
        <span class="keyword">super</span>(cause);
    }
}</code></pre></div><p>MyAuthenticatingFilter类里面需要添加验证码的判断  </p>
<p>完整如下:  </p>
<div class="highlight"><pre><code class="java"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticatingFilter</span> <span class="keyword">extends</span> <span class="title">FormAuthenticationFilter</span> </span>{

    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_CAPTCHA_PARAM = <span class="string">"captcha"</span>;

    <span class="keyword">private</span> String captchaParam = DEFAULT_CAPTCHA_PARAM;

    <span class="keyword">public</span> String getCaptchaParam() {
        <span class="keyword">return</span> captchaParam;
    }

    <span class="keyword">public</span> <span class="keyword">void</span> setCaptchaParam(String captchaParam) {
        this.captchaParam = captchaParam;
    }

    <span class="keyword">protected</span> String getCaptcha(ServletRequest request) {
        <span class="keyword">return</span> WebUtils.getCleanParam(request, getCaptchaParam());
    }

    <span class="annotation">@Override</span>
    <span class="keyword">protected</span> CaptchaUsernamePasswordToken createToken(ServletRequest request, ServletResponse response) {
        String username = getUsername(request);
        String password = getPassword(request);
        String captcha = getCaptcha(request);
        <span class="keyword">boolean</span> rememberMe = isRememberMe(request);
        String host = getHost(request);
        <span class="keyword">return</span> <span class="keyword">new</span> CaptchaUsernamePasswordToken(username, password.toCharArray(), rememberMe, host, captcha);
    }

    <span class="comment">// 验证码校验</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> doCaptchaValidate(HttpServletRequest request, CaptchaUsernamePasswordToken token) {
        <span class="comment">// session中的图形码字符串</span>
        String captcha = (String) request.getSession().getAttribute(
                AppConstants.CAPTCHA_CODE);
        <span class="comment">// 比对</span>
        <span class="keyword">if</span> (captcha != <span class="keyword">null</span> &amp;&amp; !captcha.equalsIgnoreCase(token.getCaptcha())) {
            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectCaptchaException(<span class="string">"验证码错误！"</span>);
        }
    }

    <span class="annotation">@Override</span>
    <span class="keyword">protected</span> <span class="keyword">boolean</span> executeLogin(ServletRequest request, ServletResponse response) <span class="keyword">throws</span> Exception {
        CaptchaUsernamePasswordToken token = createToken(request, response);
        <span class="keyword">if</span> (token == <span class="keyword">null</span>) {
            String msg = <span class="string">"createToken method implementation returned null. A valid non-null AuthenticationToken "</span> +
                    <span class="string">"must be created in order to execute a login attempt."</span>;
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg);
        }
        <span class="keyword">try</span> {
            doCaptchaValidate((HttpServletRequest)request, token);
            Subject subject = getSubject(request, response);
            subject.login(token);
            <span class="keyword">return</span> onLoginSuccess(token, subject, request, response);
        } <span class="keyword">catch</span> (AuthenticationException e) {
            <span class="keyword">return</span> onLoginFailure(token, e, request, response);
        }
    }

    <span class="annotation">@Override</span>
    <span class="keyword">protected</span> <span class="keyword">void</span> setFailureAttribute(ServletRequest request, AuthenticationException ae) {
        <span class="javadoc">/** 放入异常的完整信息，控制层controller需要用到 */</span>
        request.setAttribute(getFailureKeyAttribute(), ae);
    }

}</code></pre></div><p>LoginController部分代码:</p>
<div class="highlight"><pre><code class="java">Object obj = request.getAttribute(FormAuthenticationFilter.DEFAULT_ERROR_KEY_ATTRIBUTE_NAME);
AuthenticationException authExp = (AuthenticationException) obj;
<span class="keyword">if</span> (authExp != <span class="keyword">null</span>) {
    <span class="keyword">if</span>(authExp <span class="keyword">instanceof</span> IncorrectCaptchaException){
    model.addAttribute(<span class="string">"errorCode"</span>, <span class="string">"2"</span>);  
    model.addAttribute(<span class="string">"error"</span>, <span class="string">"* 验证码错误"</span>);
    }
    <span class="keyword">else</span> <span class="keyword">if</span>(authExp <span class="keyword">instanceof</span> UnknownAccountException || authExp <span class="keyword">instanceof</span> IncorrectCredentialsException){
    model.addAttribute(<span class="string">"errorCode"</span>, <span class="string">"1"</span>);  
    model.addAttribute(<span class="string">"error"</span>, <span class="string">"* 用户名或密码错误"</span>);
    }     

    <span class="keyword">return</span> loginPage(model);
}</code></pre></div><p>参考网址: <a href="http://blog.csdn.net/zhengwei223/article/details/9969831">http://blog.csdn.net/zhengwei223/article/details/9969831</a></p>

</article>
<div class="meta">
    <ul class="tags">
            <li><a href="/tag/shiro">shiro</a></li>
    </ul>
</div>
<div class="date">2014-12-08</div>
<div class="ds-thread"></div>
<script type="text/javascript">
	var duoshuoQuery = {short_name:"dmxiaoshen"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
            <!-- Duoshuo Comment END -->

        </section>
    </div>
    <footer>
    © 2015-2016 dmxiaoshen's Blog | Powered by <a href="http://lab.lepture.com/nico/" target="_blank">Nico</a>
</footer>
<script defer async type="text/javascript" src="//hm.baidu.com/h.js?f10c9b0005de625e589f7dc9804b2787"></script>

    <script defer async type="text/javascript" src="../static/js/run_prettify.js"></script>
</body>
</html>