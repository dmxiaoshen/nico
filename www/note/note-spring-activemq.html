<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Spring与ActiveMQ的整合</title>
	<link rel="shortcut icon" href="../static/img/favicon.ico">
    <link rel="stylesheet" type="text/css" media="all" href="../static/css/style.css" />
	<link rel="stylesheet" type="text/css" media="all" href="../static/css/highlight.css" />
    <link rel="stylesheet" type="text/css" media="all" href="../static/css/prettify.css" />
</head>
<body>
    <div id="primary">
        <header id="header">
    <h1 id="site-title">
        <a href="/" title="dmxiaoshen's Blog" rel="home">
            dmxiaoshen's Blog
        </a>
    </h1>
    <nav id="nav">
        <ul>
            <li>
                <a href="/note/">
                    晴耕
                </a>
            </li>
            <li>
                <a href="/article/">
                    雨读
                </a>
            </li>
        </ul>
    </nav>
</header>
        <section id="content">
<h2 class="post_title">Spring与ActiveMQ的整合</h2>
<article>
    <h2 id="activemq简介">ActiveMQ简介</h2><blockquote>
<p>企业消息软件从80年代起就存在，它不只是一种应用间消息传递风格，也是一种集成风格。因此，消息传递可以满足应用间的通知和互相操作。但是开源的解决方案是到最近10年才出现的。Apache ActiveMQ就是其中一种。它使应用间能以异步，松耦合方式交流。<br>ActiveMQ是Apache软件基金下的一个开源软件，它遵循JMS1.1规范（Java Message Service），是消息驱动中间件软件（MOM）。它为企业消息传递提供高可用，出色性能，可扩展，稳定和安全保障。ActiveMQ使用Apache许可协议。<br>因此，任何人都可以使用和修改它而不必反馈任何改变。这对于商业上将ActiveMQ用在重要用途的人尤为关键。MOM的工作是在分布式的各应用之间调度事件和消息。所以高可用，高性能，高可扩展性尤为关键。<br>ActiveMQ的目标是在尽可能多的平台和语言上提供一个标准的，消息驱动的应用集成。ActiveMQ实现JMS规范并在此之上提供大量额外的特性。</p>
</blockquote>
<h2 id="下载及配置">下载及配置</h2><!--more-->

<p>到官网下载；<a href="http://activemq.apache.org/">ActiveMQ</a><br>下载完成解压zip文件，进入bin目录启动activemq.bat便可以启动服务，类似于tomcat。  </p>
<p>如果是maven项目:</p>
<div class="highlight"><pre><code class="xml"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span>  
    <span class="tag">&lt;<span class="title">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span>  
    <span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>spring-jms<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span>  
    <span class="tag">&lt;<span class="title">version</span>&gt;</span>3.1.2.RELEASE<span class="tag">&lt;/<span class="title">version</span>&gt;</span>  
<span class="tag">&lt;/<span class="title">dependency</span>&gt;</span>   
<span class="tag">&lt;<span class="title">dependency</span>&gt;</span>  
    <span class="tag">&lt;<span class="title">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span>  
    <span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>activemq-core<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span>  
    <span class="tag">&lt;<span class="title">version</span>&gt;</span>5.10.0<span class="tag">&lt;/<span class="title">version</span>&gt;</span>  
<span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></code></pre></div><p>如果不是maven项目，那就要把所有依赖到的jar包放入lib中，具体哪些jar包可以到网上查找，上面解压的zip文件中的lib目录应该会有所需的jar包。  </p>
<h2 id="spring的配置以及相关类的创建">Spring的配置以及相关类的创建</h2><div class="highlight"><pre><code class="xml"><span class="comment">&lt;!-- 真正可以产生Connection的ConnectionFactory，由对应的 JMS服务厂商提供 --&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"connectinFactory"</span> <span class="attribute">class</span>=<span class="value">"org.apache.activemq.ActiveMQConnectionFactory"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"brokerURL"</span> <span class="attribute">value</span>=<span class="value">"tcp://127.0.0.1:61616"</span> /&gt;</span>
<span class="tag">&lt;/<span class="title">bean</span>&gt;</span>

<span class="comment">&lt;!-- Spring用于管理真正的ConnectionFactory的ConnectionFactory --&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"cachingConnectionFactory"</span>
    <span class="attribute">class</span>=<span class="value">"org.springframework.jms.connection.CachingConnectionFactory"</span>&gt;</span>
    <span class="comment">&lt;!-- 目标ConnectionFactory对应真实的可以产生JMS Connection的ConnectionFactory --&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"targetConnectionFactory"</span> <span class="attribute">ref</span>=<span class="value">"connectinFactory"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="comment">&lt;!-- Session缓存数量 --&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"sessionCacheSize"</span> <span class="attribute">value</span>=<span class="value">"30"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
<span class="tag">&lt;/<span class="title">bean</span>&gt;</span>

<span class="comment">&lt;!-- Spring JMS Template 配置JMS模版 --&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"jmsTemplate"</span> <span class="attribute">class</span>=<span class="value">"org.springframework.jms.core.JmsTemplate"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"connectionFactory"</span> <span class="attribute">ref</span>=<span class="value">"cachingConnectionFactory"</span> /&gt;</span>
<span class="tag">&lt;/<span class="title">bean</span>&gt;</span>

<span class="comment">&lt;!-- 配置消息发送目的地方式 --&gt;</span>
<span class="comment">&lt;!-- Queue队列：仅有一个订阅者会收到消息，消息一旦被处理就不会存在队列中 --&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"notifyQueue"</span> <span class="attribute">class</span>=<span class="value">"org.apache.activemq.command.ActiveMQQueue"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">constructor-arg</span> <span class="attribute">value</span>=<span class="value">"q.notify"</span>&gt;</span><span class="tag">&lt;/<span class="title">constructor-arg</span>&gt;</span>
<span class="tag">&lt;/<span class="title">bean</span>&gt;</span>

<span class="comment">&lt;!--消息转换类--&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"messageConverter"</span> <span class="attribute">class</span>=<span class="value">"com.dmxiaoshen.activemq.converter.NotifyMessageConverter"</span>&gt;</span><span class="tag">&lt;/<span class="title">bean</span>&gt;</span>

<span class="comment">&lt;!-- 使用Spring JmsTemplate 的消息生产者 --&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"messageProducer"</span> <span class="attribute">class</span>=<span class="value">"com.dmxiaoshen.activemq.producer.MessageProducer"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"jmsTemplate"</span> <span class="attribute">ref</span>=<span class="value">"jmsTemplate"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"notifyQueue"</span> <span class="attribute">ref</span>=<span class="value">"notifyQueue"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"messageConverter"</span> <span class="attribute">ref</span>=<span class="value">"messageConverter"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
<span class="tag">&lt;/<span class="title">bean</span>&gt;</span>

<span class="comment">&lt;!-- 异步接收消息处理类 及消费者--&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"messageListener"</span> <span class="attribute">class</span>=<span class="value">"com.dmxiaoshen.activemq.listener.MessageListener"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"messageConverter"</span> <span class="attribute">ref</span>=<span class="value">"messageConverter"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
<span class="tag">&lt;/<span class="title">bean</span>&gt;</span>

<span class="comment">&lt;!-- 消息消费者 一般使用spring的MDP异步接收Queue模式 --&gt;</span>
<span class="comment">&lt;!-- 消息监听容器 --&gt;</span>
<span class="comment">&lt;!--说的通俗点就是把生产者，消费者，连接，消息目的地组装起来--&gt;</span>
<span class="tag">&lt;<span class="title">bean</span> <span class="attribute">id</span>=<span class="value">"hqQueueContainer"</span>
    <span class="attribute">class</span>=<span class="value">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"connectionFactory"</span> <span class="attribute">ref</span>=<span class="value">"cachingConnectionFactory"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"destination"</span> <span class="attribute">ref</span>=<span class="value">"notifyQueue"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"messageListener"</span> <span class="attribute">ref</span>=<span class="value">"messageListener"</span>&gt;</span><span class="tag">&lt;/<span class="title">property</span>&gt;</span>
    <span class="tag">&lt;<span class="title">property</span> <span class="attribute">name</span>=<span class="value">"concurrency"</span> <span class="attribute">value</span>=<span class="value">"30"</span>/&gt;</span><span class="comment">&lt;!-- 这个属性很关键，最大并发数30，也就是启动30个实例来消费 --&gt;</span>
<span class="tag">&lt;/<span class="title">bean</span>&gt;</span></code></pre></div><p>Spring的配置到这里结束了，可以看出其中有3个类是需要自己建的，<strong>NotifyMessageConverter</strong>，<strong>MessageProducer</strong>，<strong>MessageListener</strong>。  </p>
<p>额外多一个<strong>PhoneNoticeInfo</strong>类，实现序列化接口，用以传递信息。</p>
<p><strong>PhoneNoticeInfo</strong></p>
<div class="highlight"><pre><code class="java"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneNoticeInfo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>{
 <span class="javadoc">/** 消息标题 */</span>
 <span class="keyword">public</span> String noticeTitle;
 <span class="javadoc">/** 消息内容 */</span>
 <span class="keyword">public</span> String noticeContent;
 <span class="javadoc">/** 接收者 */</span>
 <span class="keyword">public</span> String receiver;
 <span class="javadoc">/** 接收手机号 */</span>
 <span class="keyword">public</span> String receiverPhone;
 <span class="keyword">public</span> String getNoticeTitle() {
  <span class="keyword">return</span> noticeTitle;
 }
 <span class="keyword">public</span> <span class="keyword">void</span> setNoticeTitle(String noticeTitle) {
  this.noticeTitle = noticeTitle;
 }
 <span class="keyword">public</span> String getNoticeContent() {
  <span class="keyword">return</span> noticeContent;
 }
 <span class="keyword">public</span> <span class="keyword">void</span> setNoticeContent(String noticeContent) {
  this.noticeContent = noticeContent;
 }
 <span class="keyword">public</span> String getReceiver() {
  <span class="keyword">return</span> receiver;
 }
 <span class="keyword">public</span> <span class="keyword">void</span> setReceiver(String receiver) {
  this.receiver = receiver;
 }

 <span class="keyword">public</span> String getReceiverPhone() {
  <span class="keyword">return</span> receiverPhone;
 }
 <span class="keyword">public</span> <span class="keyword">void</span> setReceiverPhone(String receiverPhone) {
  this.receiverPhone = receiverPhone;
 }

}</code></pre></div><p>以下给出3个类的实现:</p>
<p><strong>NotifyMessageConverter</strong></p>
<div class="highlight"><pre><code class="java"><span class="javadoc">/**
 * 消息转换
 */</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NotifyMessageConverter</span> <span class="keyword">implements</span> <span class="title">MessageConverter</span> </span>{
 <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(NotifyMessageConverter.<span class="class"><span class="keyword">class</span>);
 @<span class="title">Override</span>
 /**
  * 转换接收到的消息为<span class="title">NoticeInfo</span>对象
  */
 <span class="title">public</span> <span class="title">Object</span> <span class="title">fromMessage</span>(<span class="title">Message</span> <span class="title">message</span>) <span class="title">throws</span> <span class="title">JMSException</span>,
   <span class="title">MessageConversionException</span> </span>{
  <span class="keyword">if</span> (logger.isDebugEnabled()) {
   logger.debug(<span class="string">"Receive JMS message :"</span>+message);
  }
  <span class="keyword">if</span> (message <span class="keyword">instanceof</span> ObjectMessage) {
   ObjectMessage oMsg = (ObjectMessage)message;
   <span class="keyword">if</span> (oMsg <span class="keyword">instanceof</span> ActiveMQObjectMessage) {
    ActiveMQObjectMessage aMsg = (ActiveMQObjectMessage)oMsg;
    <span class="keyword">try</span> {
     PhoneNoticeInfo noticeInfo = (PhoneNoticeInfo)aMsg.getObject();
     <span class="keyword">return</span> noticeInfo;
    } <span class="keyword">catch</span> (Exception e) {
     logger.error(<span class="string">"Message:${} is not a instance of NoticeInfo."</span>+message.toString());
     <span class="keyword">throw</span> <span class="keyword">new</span> JMSException(<span class="string">"Message:"</span>+message.toString()+<span class="string">"is not a instance of NoticeInfo."</span>+message.toString());
    }
   }<span class="keyword">else</span>{
    logger.error(<span class="string">"Message:${} is not a instance of ActiveMQObjectMessage."</span>+message.toString());
    <span class="keyword">throw</span> <span class="keyword">new</span> JMSException(<span class="string">"Message:"</span>+message.toString()+<span class="string">"is not a instance of ActiveMQObjectMessage."</span>+message.toString());
   }
  }<span class="keyword">else</span> {
   logger.error(<span class="string">"Message:${} is not a instance of ObjectMessage."</span>+message.toString());
   <span class="keyword">throw</span> <span class="keyword">new</span> JMSException(<span class="string">"Message:"</span>+message.toString()+<span class="string">"is not a instance of ObjectMessage."</span>+message.toString());
  }
 }

 <span class="annotation">@Override</span>
 <span class="javadoc">/**
  * 转换NoticeInfo对象到消息
  */</span>
 <span class="keyword">public</span> Message toMessage(Object obj, Session session) <span class="keyword">throws</span> JMSException,
   MessageConversionException {
  <span class="keyword">if</span> (logger.isDebugEnabled()) {
   logger.debug(<span class="string">"Convert Notify object to JMS message:${}"</span>+obj.toString());
  }
  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> PhoneNoticeInfo) {
   ActiveMQObjectMessage msg = (ActiveMQObjectMessage)session.createObjectMessage();
   msg.setObject((PhoneNoticeInfo)obj);
   <span class="keyword">return</span> msg;
  }<span class="keyword">else</span> {
   logger.debug(<span class="string">"Convert Notify object to JMS message:${}"</span>+obj.toString());
  }
  <span class="keyword">return</span> <span class="keyword">null</span>;
 }

}</code></pre></div><p><strong>MessageProducer</strong>  </p>
<div class="highlight"><pre><code class="java"><span class="javadoc">/**
 * 消息生产者服务类
 */</span>
<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProducer</span> </span>{
 <span class="keyword">private</span> JmsTemplate jmsTemplate;
 <span class="keyword">private</span> Destination notifyQueue;
 <span class="keyword">private</span> NotifyMessageConverter messageConverter;

 <span class="keyword">public</span> <span class="keyword">void</span> sendQueue(PhoneNoticeInfo noticeInfo){
  sendMessage(noticeInfo);
 }
 <span class="keyword">private</span> <span class="keyword">void</span> sendMessage(PhoneNoticeInfo noticeInfo) {
  jmsTemplate.setMessageConverter(messageConverter);
  jmsTemplate.setPubSubDomain(<span class="keyword">false</span>);
  jmsTemplate.convertAndSend(notifyQueue,noticeInfo);
 }
 <span class="keyword">public</span> JmsTemplate getJmsTemplate() {
  <span class="keyword">return</span> jmsTemplate;
 }
 <span class="keyword">public</span> <span class="keyword">void</span> setJmsTemplate(JmsTemplate jmsTemplate) {
  this.jmsTemplate = jmsTemplate;
 }
 <span class="keyword">public</span> Destination getNotifyQueue() {
  <span class="keyword">return</span> notifyQueue;
 }
 <span class="keyword">public</span> <span class="keyword">void</span> setNotifyQueue(Destination notifyQueue) {
  this.notifyQueue = notifyQueue;
 }
 <span class="keyword">public</span> NotifyMessageConverter getMessageConverter() {
  <span class="keyword">return</span> messageConverter;
 }
 <span class="keyword">public</span> <span class="keyword">void</span> setMessageConverter(NotifyMessageConverter messageConverter) {
  this.messageConverter = messageConverter;
 }
}</code></pre></div><p><strong>MessageListener</strong>  </p>
<div class="highlight"><pre><code class="java"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>{
 <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(QueueMessageListener.<span class="class"><span class="keyword">class</span>);
 <span class="title">private</span> <span class="title">NotifyMessageConverter</span> <span class="title">messageConverter</span>;

 /**
  * 接收消息
  */
 @<span class="title">Override</span>
 <span class="title">public</span> <span class="title">void</span> <span class="title">onMessage</span>(<span class="title">Message</span> <span class="title">message</span>) </span>{
  <span class="keyword">try</span> {
   ObjectMessage objectMessage = (ObjectMessage)message;
   PhoneNoticeInfo noticeInfo = (PhoneNoticeInfo)messageConverter.fromMessage(objectMessage);
   System.out.println(<span class="string">"queue收到消息"</span>+noticeInfo.getNoticeContent());
   System.out.println(<span class="string">"model:"</span>+objectMessage.getJMSDeliveryMode()); 
   System.out.println(<span class="string">"destination:"</span>+objectMessage.getJMSDestination()); 
   System.out.println(<span class="string">"type:"</span>+objectMessage.getJMSType()); 
   System.out.println(<span class="string">"messageId:"</span>+objectMessage.getJMSMessageID()); 
   System.out.println(<span class="string">"time:"</span>+objectMessage.getJMSTimestamp()); 
   System.out.println(<span class="string">"expiredTime:"</span>+objectMessage.getJMSExpiration()); 
   System.out.println(<span class="string">"priority:"</span>+objectMessage.getJMSPriority()); 

  } <span class="keyword">catch</span> (Exception e) {
   logger.error(<span class="string">"处理信息时发生异常"</span>,e);
  }
 }
 <span class="keyword">public</span> NotifyMessageConverter getMessageConverter() {
  <span class="keyword">return</span> messageConverter;
 }
 <span class="keyword">public</span> <span class="keyword">void</span> setMessageConverter(NotifyMessageConverter messageConverter) {
  this.messageConverter = messageConverter;
 }

}</code></pre></div><p>上述就是所需的类，只需调用MessageProducer实例的sendQueue方法，就可以发送消息到队列了。<br>需要在此处<code>&lt;property name=&quot;brokerURL&quot; value=&quot;tcp://127.0.0.1:61616&quot; /&gt;</code>配置的服务器上启动activemq服务。<br>浏览器进入<a href="http://127.0.0.1:8161/admin/queues.jsp">ActiveMQ管理页面</a>即可查看队列的信息。<br>用户名 admin 密码 admin</p>

</article>
<div class="meta">
    <ul class="tags">
            <li><a href="/tag/activemq">activemq</a></li>
    </ul>
</div>
<div class="date">2015-01-13</div>
<div class="ds-thread"></div>
<script type="text/javascript">
	var duoshuoQuery = {short_name:"dmxiaoshen"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
            <!-- Duoshuo Comment END -->

        </section>
    </div>
    <footer>
    © 2015-2016 dmxiaoshen's Blog | Powered by <a href="http://lab.lepture.com/nico/" target="_blank">Nico</a>
</footer>
<script defer async type="text/javascript" src="//hm.baidu.com/h.js?f10c9b0005de625e589f7dc9804b2787"></script>

    <script defer async type="text/javascript" src="../static/js/run_prettify.js"></script>
	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?84405cc8993d00d19f760d6fa7ec02ca";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>

</body>
</html>