<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>Oracle中merge into用法</title>
	<link rel="shortcut icon" href="../static/img/favicon.ico">
    <link rel="stylesheet" type="text/css" media="all" href="../static/css/style.css" />
	<link rel="stylesheet" type="text/css" media="all" href="../static/css/highlight.css" />
    <link rel="stylesheet" type="text/css" media="all" href="../static/css/prettify.css" />
</head>
<body>
    <div id="primary">
        <header id="header">
    <h1 id="site-title">
        <a href="/" title="dmxiaoshen's Blog" rel="home">
            dmxiaoshen's Blog
        </a>
    </h1>
    <nav id="nav">
        <ul>
            <li>
                <a href="/note/">
                    晴耕
                </a>
            </li>
            <li>
                <a href="/article/">
                    雨读
                </a>
            </li>
        </ul>
    </nav>
</header>
        <section id="content">
<h2 class="post_title">Oracle中merge into用法</h2>
<article>
    <h2 id="介绍">介绍</h2><p>merge命令可以用来处理一个表中的数据插入或更新到另一个表，也可以对单表处理，存在则修改不存在则插入。  </p>
<h2 id="语法">语法</h2><div class="highlight"><pre><code class="sql">merge into table a
using table b
on (a.xxx=b.xxx)
when matched then
<span class="operator"><span class="keyword">update</span> <span class="keyword">set</span> a.col=b.col
<span class="keyword">when</span> <span class="keyword">not</span> matched <span class="keyword">then</span>
<span class="keyword">insert</span>(col1,col2,col3) <span class="keyword">values</span>(b.col1,b.col2,b.col3)</span></code></pre></div><p>以上是最基础的语法,简单分析下:  </p>
<ul>
<li>table a  插入或修改数据的目标表</li>
<li>table b  数据源，可以是<strong>表、视图、子查询</strong> </li>
<li>on 条件 满足则修改，不满足插入</li>
</ul>
<h2 id="实战">实战</h2><h3 id="场景一">场景一</h3><p><strong>有一张产品表production,已有一些数据,现在又有一张production_new表，并且从外部导入了一些数据，现在要把production_new表的数据整合到production表中去，<br>原有的production数据当然是不能删的，因为其主键id已被很多地方依赖, 这个时候 merge into就能发挥作用了</strong>  </p>
<div class="highlight"><pre><code class="sql">merge into production a
using production_new b
on (a.产品编号=b.产品编号)
when matched then 
<span class="operator"><span class="keyword">update</span> <span class="keyword">set</span> a.x=b.x,a.xx=b.xx,a.xxx=b.xxx
<span class="keyword">when</span> <span class="keyword">not</span> matched <span class="keyword">then</span>
<span class="keyword">insert</span>(x,xx,xxx) <span class="keyword">values</span>(b.x,b.xx,b.xxx)</span></code></pre></div><h3 id="场景二">场景二</h3><p><strong>有一张表production,已有数据,但是程序中会不时的获取一些信息插入该表，对已经存在相同编号(字段为pro_no)的产品只需update，如是新产品则insert</strong>  </p>
<div class="highlight"><pre><code class="sql">merge into production a
using (<span class="operator"><span class="keyword">select</span> <span class="string">'100001'</span> <span class="keyword">as</span> pro_no <span class="keyword">from</span> dual) b
<span class="keyword">on</span> (a.pro_no=b.pro_no)
<span class="keyword">when</span> matched <span class="keyword">then</span>
<span class="keyword">update</span> <span class="keyword">set</span> a.x=新值<span class="number">1</span>,a.xx=新值<span class="number">2</span>,a.xxxx=新值<span class="number">3</span>
<span class="keyword">when</span> <span class="keyword">not</span> matched <span class="keyword">then</span> 
<span class="keyword">insert</span>(pro_no,x,xx,xxx) <span class="keyword">values</span>(<span class="string">'100001'</span>,新值<span class="number">1</span>,新值<span class="number">2</span>,新值<span class="number">3</span>)</span></code></pre></div><p>如果存在编号为100001的产品则更新，否则新增。</p>
<h2 id="千万注意">千万注意</h2><p>b中select出来的数据，每一条都跟a进行on中的条件比较，如果满足则更新，不满足就插入。<br>换句话说<strong>更新与插入的总记录数，就是b中select出来的记录数</strong><br>所以如果想要语句按你的逻辑走，第一步就要检查b中是否能select出数据。</p>

</article>
<div class="meta">
    <ul class="tags">
            <li><a href="/tag/oracle">oracle</a></li>
    </ul>
</div>
<div class="date">2015-01-04</div>
<div class="ds-thread"></div>
<script type="text/javascript">
	var duoshuoQuery = {short_name:"dmxiaoshen"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
</script>
            <!-- Duoshuo Comment END -->

        </section>
    </div>
    <footer>
    © 2015-2016 dmxiaoshen's Blog | Powered by <a href="http://lab.lepture.com/nico/" target="_blank">Nico</a>
</footer>
<script defer async type="text/javascript" src="//hm.baidu.com/h.js?f10c9b0005de625e589f7dc9804b2787"></script>

    <script defer async type="text/javascript" src="../static/js/run_prettify.js"></script>
</body>
</html>